# 总结一下之前的工作项目算是备忘录

## 天津深思维科技有限公司

### 一. MRCP服务器：

使用开源的MRCPv2协议服务器unimrcp对语音合成和语音识别等流媒体功能进行封装。

1. 基于unimrcp和各种第三方服务（ASR、TTS），实现了语音合成和语音识别插件。
   调用NLP模型和逻辑推理机实现了语音对话能力。
2. 对接Genesys、联通呼叫中心等平台，对语音识别结果进行模板化处理。
   使用gdb解决了内存泄漏问题，并对语音合成结果进行缓存，减少了服务调用次数。

总结:

1. 这里的整个流程就是,将用户的说的话,调用asr将语音转为文字.将文字传入nlp服务,得到回复的文字,调用tts将文字转语音发送给客户,完成一次交互.
   nlp服务是由nlp模型和对话树组成的服务,模型只是为了算语义相似度,用来匹配最合适的话术分支.
2. 整个服务是基于配置的,因为对接了阿里,腾讯,科大迅飞还有一些小的ai厂商的能力,每个厂商的价格和准确率都不一直,所以根据用户购买的不同价格的服务
   配置去调用不同的服务方.
3. 对接这些呼叫中心的时候,由于对方方案老旧和人员流失,对于协议本身已经没有了解的人了,协议body使用了叫做vxml的变体,所以我的做法就是和对方的运维人员进行沟通
   从日志中获取对方标准的body,我把xml写入文件,当服务启动的时候加载到内存,每次返回时基于这个模板做渲染即可.
4. 写c当然就会内存泄漏就要使用gdb查看core dump文件来解决,首先使用ulimit -c命令查看系统是否开启了core dump,如何过没有执行ulimit
   -c unlimited.开启,需要重启系统.
5. 为了减少调用对tts服务的调用,我们会将一些文字使用md5取一个hash值,然后将这段文字合成语音存储在map里.
6. 内存泄漏就这个map引起的,这个map的策略是每一个kv对缓存3天,但这个map不是并发安全的,当一个kv对失效的时候
   这段语音在内存里已经被free了,但是map中的引用还没有被移除的时候,一个线程用md5的值访问到了,这个被free的内存.导致了野指针.解决方案使用了一个apache
   的c语言运行时里面的并发安全的map.gdb <可执行文件> <核心转储文件>查看代码堆栈信息.

### 二. 霍克动力营销系统：

基于微信公众号的营销系统，利用文字对话机器人与关注公众号的用户进行聊天，充当客服的角色。同时，在对话过程中进行数据收集，并为每个对话打上标签。后台管理者可以根据标签对粉丝进行精确的营销活动，以实现私域流量变现的目标。

我的工作：
1.开发了基于Spring Boot的邮件服务，并实现相关业务逻辑。
2.负责开发人工客服模块。
3.提供基于es的聊天记录的查询功能。
4.使用flink对会话记录进行数据统计。

总结:

1. 邮件主要是为了,当有用户发送转人工,而又没有在线客服的时候,发送邮件给固定的运营人员进行提醒.
2. 我们有一个字段toType的字段,这个字段有两个类型,一个是人工,一个是机器人.当用户发送转人工的时候,我们就会去查看那这个字段,如果是人工类型,接下来我们回去,查看
   用户对应的客服的id,当id为null的时候说明还没有客服接待,这时候就需要把用户的toUser设置成这个客服.之后的对话就会转成用户和客服的对话流程.在netty当中链接被封装成了
   context对象,所以我们呢,有两种解决方案.存储一个全局的map<userId,context>,或者将context作为user的一个成员变量.这样就可以在去要发送的数据的时候获取连接.
3. 使用es提供聊天记录的查询,首先要做数据同步,这里我们使用的是基于双写的方案.如何保证mysql和es双写的一致性呢.首先写入mysql失败,直接抛出异常,让客户端重新发请求,
   mysql写入成功,再写入es.在写入es之前记录一条同步日志,es同步成功则更新日志,同步失败则后续根据失败日志,重新同步即可.这种方案类似写入之前记一条预写日志.
   因为没有人会发送成消息立即就去查看历史记录所以不需要考虑同步延迟的问题,由于是之后才会根据失败的日志去做同步补偿,所以是一种最终一致性的方案.双写同步个三方服务,可能会由于网络延迟
   导致实际写入成功,但是回复超时的情况.解决方案有异步:1.回调通知结果,这样就不需要阻塞式的等待了.2.重试机制,重试一定次数后彻底失败.3.记录日志4.定期对比.
   其他同步方案:1.基于消息队列的消息同步2.基于binlog的数据同步.
4. 这里只是使用flink对数据做了简单的word count.编写的大概过程就是连接mysql做数据源,选择时间窗口为滚动窗口模式,保证消息不重复统计,使用本地的set做去重.

## 上海皓齿网络科技有限公司

一. 齿研社小程序和CRM：
齿科医疗服务领域的电商小程序以及商家后台管理系统。

我的工作：
1.根据产品需求进行相关应用的开发，进行周期性版本迭代。
2.对接阿里健康、京东等健康第三方平台的医疗电商平台，实现商品的多平台发布。
3.基于binlog实现数据同步和消息发送功能。
4.利用Elasticsearch实现了综合搜索功能。

总结:
